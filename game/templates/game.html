<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Meaning Space Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .pulsate {
            animation: pulsate 1.5s infinite ease-in-out;
        }

        @keyframes pulsate {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Plotlyã®ãƒ†ã‚­ã‚¹ãƒˆãŒé¸æŠã•ã‚Œã‚‹ã®ã‚’é˜²ã (ä»»æ„) */
        .js-plotly-plot .plotly .cursor-pointer {
            cursor: default !important;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6 font-sans">
    <h1 class="text-4xl font-bold mb-6 text-indigo-600">Meaning Space Game</h1>

    <!-- å˜èªãƒãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="scatter" class="w-full max-w-4xl h-96 bg-white shadow-xl rounded-lg mb-8 border border-gray-200"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ (ãƒ•ã‚©ãƒ¼ãƒ ã¨çµæœè¡¨ç¤º) -->
    <div class="w-full max-w-md">
        <div class="bg-white shadow-xl rounded-lg p-6 mb-8 border border-gray-200">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700" id="target-word">Target: ...</h2>
            <form id="answer" class="space-y-4">
                <div>
                    <label for="w1" class="block text-sm font-medium text-gray-700">å˜èª 1</label>
                    <input id="w1" name="w1"
                        class="mt-1 w-full border border-gray-300 p-3 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="é–¢é€£ã™ã‚‹å˜èªã‚’å…¥åŠ›" />
                </div>
                <div>
                    <label for="w2" class="block text-sm font-medium text-gray-700">å˜èª 2</label>
                    <input id="w2" name="w2"
                        class="mt-1 w-full border border-gray-300 p-3 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="é–¢é€£ã™ã‚‹å˜èªã‚’å…¥åŠ›" />
                </div>
                <div>
                    <label for="w3" class="block text-sm font-medium text-gray-700">å˜èª 3</label>
                    <input id="w3" name="w3"
                        class="mt-1 w-full border border-gray-300 p-3 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="é–¢é€£ã™ã‚‹å˜èªã‚’å…¥åŠ›" />
                </div>
                <div>
                    <label for="player" class="block text-sm font-medium text-gray-700">ãŠåå‰ (ä»»æ„)</label>
                    <input id="player" name="player"
                        class="mt-1 w-full border border-gray-300 p-3 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å" />
                </div>
                <button type="submit"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-4 rounded-md font-semibold shadow-md transition duration-150 ease-in-out">
                    é€ä¿¡
                </button>
            </form>
        </div>

        <!-- ã‚¹ã‚³ã‚¢çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="result-area" class="mb-8">
            <!-- JavaScriptã§ã“ã“ã«ã‚¹ã‚³ã‚¢çµæœãŒæŒ¿å…¥ã•ã‚Œã‚‹ -->
        </div>

        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="ranking-container" class="bg-white shadow-xl rounded-lg p-6 border border-gray-200">
            <h2 class="text-2xl font-bold mb-4 text-center text-yellow-500">ğŸ† TOP 3 Ranking ğŸ†</h2>
            <ul id="ranking-list" class="list-none p-0 space-y-3">
                <li class="text-gray-500 text-center py-2">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>
            </ul>
        </div>
    </div>

    <script>
        const scatterDiv = document.getElementById("scatter");
        const targetSpan = document.getElementById("target-word");
        const resultArea = document.getElementById("result-area");
        const rankingList = document.getElementById("ranking-list");

        let currentTargetWordText = null; // ç¾åœ¨ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå˜èªåã‚’ä¿æŒã™ã‚‹å¤‰æ•°

        function fetchTarget() {
            targetSpan.textContent = 'Target: èª­ã¿è¾¼ã¿ä¸­...';
            fetch("/api/target")
                .then(r => r.json())
                .then(d => {
                    if (d.id && d.word && d.word.text) {
                        window.currentTargetId = d.id;
                        currentTargetWordText = d.word.text;
                        targetSpan.textContent = `Target: ${d.word.text}`;
                    } else {
                        targetSpan.textContent = 'Target: å–å¾—å¤±æ•—';
                        currentTargetWordText = null;
                        console.error("Invalid target data:", d);
                    }
                    fetchWords(); // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå–å¾—å¾Œã«ãƒãƒƒãƒ—ã‚’å†æç”»
                }).catch(err => {
                    targetSpan.textContent = 'Target: å–å¾—ã‚¨ãƒ©ãƒ¼';
                    currentTargetWordText = null;
                    console.error("Error fetching target:", err);
                    fetchWords(); // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒãƒƒãƒ—æç”»è©¦è¡Œ
                });
        }

        function fetchWords() {
            fetch("/api/words")
                .then(r => r.json())
                .then(wordsData => {
                    const allWords = wordsData.filter(w => w.x != null && w.y != null && !isNaN(w.x) && !isNaN(w.y));

                    let targetWordTrace = null;
                    const otherWords = [];

                    allWords.forEach(word => {
                        if (currentTargetWordText && word.text === currentTargetWordText) {
                            targetWordTrace = {
                                x: [word.x],
                                y: [word.y],
                                mode: 'markers+text',
                                text: [word.text],
                                textposition: 'bottom center',
                                type: 'scatter',
                                name: 'Target Word',
                                marker: {
                                    size: 18, // å°‘ã—å¤§ãã
                                    color: 'rgba(239, 68, 68, 1)', // Red-500
                                    symbol: 'star', // â˜… æ˜Ÿå½¢ãƒãƒ¼ã‚«ãƒ¼ â˜…
                                    line: {
                                        color: 'rgba(153, 27, 27, 1)', // Red-800 (æ ç·š)
                                        width: 2
                                    }
                                },
                                textfont: {
                                    family: 'Arial, sans-serif',
                                    size: 14,
                                    color: 'rgba(191, 25, 25, 1)' // Red-700 (æ–‡å­—è‰²)
                                }
                            };
                        } else {
                            otherWords.push(word);
                        }
                    });

                    const otherWordsTrace = {
                        x: otherWords.map(w => w.x),
                        y: otherWords.map(w => w.y),
                        mode: 'markers+text',
                        text: otherWords.map(w => w.text),
                        textposition: 'top center',
                        type: 'scatter',
                        name: 'Other Words',
                        marker: {
                            size: 10,
                            color: 'rgba(79, 70, 229, 0.7)' // Indigo-600
                        },
                        textfont: {
                            family: 'Arial, sans-serif',
                            size: 12,
                            color: '#333'
                        }
                    };

                    const tracesToPlot = [otherWordsTrace];
                    if (targetWordTrace) {
                        tracesToPlot.push(targetWordTrace); // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’å¾Œã‹ã‚‰è¿½åŠ ã—ã¦é‡ã­ã‚‹
                    }

                    const layout = {
                        xaxis: { showticklabels: false, ticks: '', showgrid: false, zeroline: false, fixedrange: false }, // fixedrangeã§ã‚ºãƒ¼ãƒ ã‚„ãƒ‘ãƒ³ã‚’ç„¡åŠ¹åŒ–
                        yaxis: { showticklabels: false, ticks: '', showgrid: false, zeroline: false, fixedrange: false }, // fixedrangeã§ã‚ºãƒ¼ãƒ ã‚„ãƒ‘ãƒ³ã‚’ç„¡åŠ¹åŒ–
                        margin: { l: 10, r: 10, b: 10, t: 10, pad: 0 }, // ãƒãƒ¼ã‚¸ãƒ³ã‚’è©°ã‚ã‚‹
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        showlegend: false,
                        hovermode: false // ãƒ›ãƒãƒ¼ã‚‚ç„¡åŠ¹åŒ–ã—ã¦ã‚·ãƒ³ãƒ—ãƒ«ã«
                    };

                    Plotly.newPlot(scatterDiv, tracesToPlot, layout, {
                        responsive: true,
                        displayModeBar: false // Plotlyã®ãƒ¢ãƒ¼ãƒ‰ãƒãƒ¼ã‚‚éè¡¨ç¤ºã«
                    });

                }).catch(err => {
                    console.error("Error fetching words for plot:", err);
                    scatterDiv.innerHTML = '<p class="text-center text-red-500 p-4">å˜èªãƒãƒƒãƒ—ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
                });
        }

        function fetchRanking() {
            rankingList.innerHTML = '<li class="text-gray-500 text-center py-2 pulsate">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°ä¸­...</li>';
            fetch("/api/ranking")
                .then(r => {
                    if (!r.ok) throw new Error(`Ranking fetch failed with status ${r.status}`);
                    return r.json();
                })
                .then(rankingData => {
                    rankingList.innerHTML = "";
                    if (rankingData && rankingData.length > 0) {
                        rankingData.forEach((entry, index) => {
                            const listItem = document.createElement("li");
                            listItem.className = "py-3 px-2 border-b border-gray-200 flex justify-between items-center text-lg";
                            let medal = "";
                            if (index === 0) medal = "ğŸ¥‡";
                            else if (index === 1) medal = "ğŸ¥ˆ";
                            else if (index === 2) medal = "ğŸ¥‰";

                            listItem.innerHTML = `
                                <span class="font-semibold text-gray-700">${medal} ${entry.player_name || 'åç„¡ã—ã•ã‚“'}</span>
                                <span class="text-indigo-600 font-bold">${entry.score} pts</span>
                            `;
                            rankingList.appendChild(listItem);
                        });
                        if (rankingList.lastChild) rankingList.lastChild.classList.remove('border-b');
                    } else {
                        rankingList.innerHTML = '<li class="text-gray-500 text-center py-2">ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
                    }
                })
                .catch(error => {
                    console.error("Failed to fetch ranking:", error);
                    rankingList.innerHTML = `<li class="text-red-500 text-center py-2">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</li>`;
                });
        }

        // åˆæœŸèª­ã¿è¾¼ã¿
        fetchTarget(); // fetchTargetå†…ã§fetchWordsãŒå‘¼ã°ã‚Œã‚‹
        fetchRanking();

        document.getElementById("answer").addEventListener("submit", e => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const wordsArray = [fd.get("w1"), fd.get("w2"), fd.get("w3")].filter(w => w && w.trim() !== "");

            if (wordsArray.length < 3) {
                resultArea.innerHTML = `
                    <div class="p-4 bg-red-100 border border-red-300 rounded-md shadow text-center">
                        <p class="text-red-700 font-semibold">å˜èªã‚’3ã¤å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>`;
                return;
            }

            const body = {
                player: fd.get("player") || "anon",
                target_id: window.currentTargetId,
                words: wordsArray
            };

            const button = e.target.querySelector("button[type='submit']");
            const originalButtonText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<span class="pulsate">é€ä¿¡ä¸­... ğŸ”„</span>`;
            resultArea.innerHTML = `<div class="p-4 bg-blue-50 border border-blue-200 rounded-md shadow text-center pulsate"><p class="text-blue-600">çµæœã‚’è¨ˆç®—ä¸­...</p></div>`;

            fetch("/api/score", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) })
                .then(r => {
                    if (!r.ok) {
                        return r.json().then(err => {
                            const errorMessage = err.detail || (typeof err === 'string' ? err : `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (Status: ${r.status})`);
                            throw new Error(errorMessage);
                        });
                    }
                    return r.json();
                })
                .then(res => {
                    if (res.score == null || res.similarities == null) {
                        throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
                    }
                    resultArea.innerHTML = `
                    <div class="p-6 bg-green-50 border border-green-300 rounded-lg shadow">
                        <h3 class="text-2xl font-bold mb-3 text-green-700 text-center">ã‚¹ã‚³ã‚¢: ${res.score}</h3>
                        <table class="w-full text-left text-sm">
                            <thead class="bg-green-100">
                                <tr>
                                    <th class="p-2 font-semibold text-gray-600">æå‡ºã—ãŸå˜èª</th>
                                    <th class="p-2 font-semibold text-gray-600 text-right">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã®é¡ä¼¼åº¦</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${body.words.map((w, i) => `
                                    <tr class="border-b border-green-200">
                                        <td class="p-2 text-gray-700">${w}</td>
                                        <td class="p-2 text-gray-700 text-right">${(res.similarities[i] * 100).toFixed(1)}%</td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                    fetchWords();
                    fetchRanking();
                    e.target.reset();
                })
                .catch(error => {
                    console.error('Score submission error:', error);
                    resultArea.innerHTML = `
                        <div class="p-4 bg-red-100 border border-red-300 rounded-md shadow text-center">
                            <p class="text-red-700 font-semibold">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                        </div>`;
                })
                .finally(() => {
                    button.disabled = false;
                    button.innerHTML = originalButtonText;
                });
        });
    </script>
</body>

</html>